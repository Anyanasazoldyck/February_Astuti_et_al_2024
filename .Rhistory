"percent.mt" < max_mt_pct
)
sc_list[[id]]<-sample
}
View(sc_list)
names(sc_list)
for (id in names(sc_list)){
sample <- sc_list[[id]]
sample <- subset(
sample,
subset = nFeature_RNA > min_features &
nFeature_RNA < max_features &
percent.mt < max_mt_pct
)
sc_list[[id]]<-sample
}
pdf("analysis/QCVlnPlot_PostFiler.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p <- VlnPlot(sc_list[[id]],
features = c("nCount_RNA", "nFeature_RNA","percent.mt"))+ general_theme
print(p)
}
dev.off()
dev.off()
pdf("analysis/QCVlnPlot_PostFiler.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p <- VlnPlot(sc_list[[id]],
features = c("nCount_RNA", "nFeature_RNA","percent.mt"))+ general_theme
print(p)
}
dev.off()
library(patchwork)
# Visualize scatter plot ----
pdf("analysis/QCScattePlot_PostFilter.pdf", width = 12, height = 6)
for (id in names(sc_list)){
plot1 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
print(p+p2)
}
pdf("analysis/QCScattePlot_PostFilter.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p1 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "percent.mt")
p2 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
print(p1+p2)
}
dev.off()
pdf("analysis/QCScattePlot_PostFilter.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p1 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "percent.mt")
p2 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
print(p1+p2)
}
dev.off()
# Visualize scatter plot ----
pdf("analysis/QCScattePlot_PostFilter.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p1 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "percent.mt")
p2 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
print(p1+p2)
}
dev.off()
graphics.off()
# Visualize scatter plot ----
pdf("analysis/QCScattePlot_PostFilter.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p1 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "percent.mt")
p2 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
print(p1+p2)
}
dev.off()
graphics.off()
sc_list = merge(x = sc_list[[1]], y = sc_list[[-1]])
sc_list = merge(x = sc_list[[1]], y = sc_list[-1])
sc_data<-sc_list
saveRDS(sc_data, "data/sc_data.rds")
sc_data = NormalizeData(seurat_merge, scale.factor = 10000)
sc_data = NormalizeData(sc_data, scale.factor = 10000)
sc_data = ScaleData(object = sc_data)
sc_data = FindVariableFeatures(object = sc_data, nfeatures = 2000)
sc_data[["Adgre1"]] <- PercentageFeatureSet(sc_data, features = "Adgre1")
sc_data[["Cd68"]] <- PercentageFeatureSet(sc_data, features = "Cd68")
sample_cols <- c(
GSM6622231_s1 = "#0072B2",  # blue
GSM6622232_s2 = "#E69F00",  # orange
GSM6622233_s3 = "#009E73",  # green
GSM6622234_s4 = "#CC79A7"   # purple
)
p  <- VlnPlot(sc_data, features = c("Adgre1","Cd68"), cols = sample_cols )
png("analysis/MacrophagesDist.png", width = 5, height = 20)
p
dev.off()
png("analysis/MacrophagesDist.png", width = 5, height = 20, units = "mm")
png("analysis/MacrophagesDist.png", width = 5, height = 20, units = "px")
p
dev.off()
png("analysis/MacrophagesDist.png", width = 5, height = 20, units = "mm", res = 300)
p
dev.off()
png("analysis/MacrophagesDist.png", width = 5*300, height = 20*300, units = "mm", res = 300)
png("analysis/MacrophagesDist.png", width = 5*300, height = 20*300, units = "mm", res = 300)
png("analysis/MacrophagesDist.png", width = 5*300, height = 20*300, res = 300)
p
dev.off()
png("analysis/MacrophagesDist.png", width = 10*300, height = 5*300, res = 300)
p
dev.off()
# Filter ----
sc_data <- sc_data <- subset(sc_data, subset = Adgre1 < 0 & Cd68 <0)
sc_data = merge(x = sc_list[[1]], y = sc_list[-1])
View(sc_data)
View(sc_data@meta.data)
# Filter ----
sc_data <- sc_data <- subset(sc_data, subset = Adgre1 > 0 & Cd68 >0)
dim(sc_data)
# Random seed ----
RandomSeed <- 999
# Dim Reduction and Clustering ----
sc_data <- RunPCA(sc_data, seed.use = RandomSeed)
ElbowPlot(sc_data)
dims_to_use <- 20
dims_to_use <- 20
# cluster ----
sc_data = RunUMAP(sc_data, reduction = "pca", dims = dims_to_use, seed.use = RandomSeed)
dims_to_use <- 1:20
sc_data = RunUMAP(sc_data, reduction = "pca", dims = dims_to_use, seed.use = RandomSeed)
DimPlot(sc_data)
sc_data <- FindNeighbors(object = sc_data,
dims = dims_to_use)
sc_data <- FindClusters(object = sc_data,
resolution = 0.44,
random.seed = RandomSeed)
DimPlot(sc_data)
umap_theme = theme(plot.title = element_text(hjust = 0.5),
axis.text = element_blank(),
axis.title = element_text(size = 12),
text = element_text(size = 12, family = "ArialMT"),
axis.ticks = element_blank())
sc_data = RunUMAP(sc_data, reduction = "pca", dims = dims_to_use, seed.use = RandomSeed)
DimPlot(sc_data)
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5) +umap_theme
dev.off()
# I used the same themes
umap_theme = theme(plot.title = element_text(hjust = 0.5),
legend.position = "none",
axis.text = element_blank(),
axis.title = element_text(size = 12),
text = element_text(size = 12, family = "ArialMT"),
axis.ticks = element_blank())
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T, label.size = 1) +umap_theme
dev.off()
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T,
label.size = 1, label.color = "black") +umap_theme
dev.off()
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T,
label.size = 8, label.color = "black") +umap_theme
dev.off()
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T,
label.size = 6, label.color = "black") +umap_theme
dev.off()
png("analysis/umapBySample.png",res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T,
label.size = 5, label.color = "black", group.by = "group",
cols = sample_cols) +umap_theme
dev.off()
png("analysis/umapBySample.png",res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T,
label.size = 5, label.color = "black", group.by = "group") +umap_theme
dev.off()
png("analysis/umapBySample.png",res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = F, label = T,
label.size = 5, label.color = "black", group.by = "group") +umap_theme
dev.off()
#create seurat object####
#set a list
create_seurat_list <- function(sample_sheet, data_path){
seurat_list <- list()
for (sample_name in sample_sheet$sample_id){
#record sample path
message (sample_name)
feat = paste0(sample_name,"_features.tsv.gz")
bc = paste0(sample_name,"_barcodes.tsv.gz")
mtx = paste0(sample_name,"_matrix.mtx.gz")
feat_file = file.path(data_path,feat)
bc_file = file.path(data_path,bc)
mtx_file = file.path(data_path,mtx)
if (!file.exists(mtx_file)) {
print("mtx does not exist")
}
if (!file.exists(feat_file)) {
print("feat_file does not exist")
}
if (!file.exists(bc_file)) {
print("bc_file does not exist")
}
#read data
data <- ReadMtx  (
mtx  = mtx_file,
features = feat_file,
cells = bc_file
)
#create seurat samples while setting the name of the asample_sheetay and project
sc_obj= CreateSeuratObject(counts = data,project = sample_name,assay = "RNA")
#add metadata
meta_row = sample_sheet[sample_sheet$sample_id==sample_name,] #match meta to p
sc_obj$group = meta_row$group
sc_obj$timepoint = meta_row$timepoint
seurat_list[[sample_name]]<-sc_obj
}
return(seurat_list)
}
# library
library(Seurat)
library(ggplot2)
library(patchwork)
rm(list=ls())
#set working dir####
setwd("D:/PDAC_liver_metastasis")
#set themes ###
general_theme = theme(text = element_text(size = 12, family = "ArialMT"))
# I used the same themes
umap_theme = theme(plot.title = element_text(hjust = 0.5),
legend.position = "none",
axis.text = element_blank(),
axis.title = element_text(size = 12),
text = element_text(size = 12, family = "ArialMT"),
axis.ticks = element_blank())
sample_cols <- c(
GSM6622231_s1 = "#0072B2",  # blue
GSM6622232_s2 = "#E69F00",  # orange
GSM6622233_s3 = "#009E73",  # green
GSM6622234_s4 = "#CC79A7"   # purple
)
# Random seed ----
RandomSeed <- 999
# load data ----
ss<- readxl::read_xlsx("data/ss.xlsx")
data_dir <- "data/samples"
sc_list <- create_seurat_list(ss, data_path = data_dir)
#create seurat object####
#set a list
create_seurat_list <- function(sample_sheet, data_path){
seurat_list <- list()
for (sample_name in sample_sheet$sample_id){
#record sample path
message (sample_name)
feat = paste0(sample_name,"_features.tsv.gz")
bc = paste0(sample_name,"_barcodes.tsv.gz")
mtx = paste0(sample_name,"_matrix.mtx.gz")
feat_file = file.path(data_path,feat)
bc_file = file.path(data_path,bc)
mtx_file = file.path(data_path,mtx)
if (!file.exists(mtx_file)) {
print("mtx does not exist")
}
if (!file.exists(feat_file)) {
print("feat_file does not exist")
}
if (!file.exists(bc_file)) {
print("bc_file does not exist")
}
#read data
data <- ReadMtx  (
mtx  = mtx_file,
features = feat_file,
cells = bc_file
)
#create seurat samples while setting the name of the asample_sheetay and project
sc_obj= CreateSeuratObject(counts = data,project = sample_name,assay = "RNA")
#add metadata
meta_row = sample_sheet[sample_sheet$sample_id==sample_name,] #match meta to p
sc_obj$group = meta_row$group
sc_obj$timepoint = meta_row$timepoint
seurat_list[[sample_name]]<-sc_obj
}
return(seurat_list)
}
# library
library(Seurat)
library(ggplot2)
library(patchwork)
rm(list=ls())
#set working dir####
setwd("D:/PDAC_liver_metastasis")
#set themes ###
general_theme = theme(text = element_text(size = 12, family = "ArialMT"))
# I used the same themes
umap_theme = theme(plot.title = element_text(hjust = 0.5),
legend.position = "none",
axis.text = element_blank(),
axis.title = element_text(size = 12),
text = element_text(size = 12, family = "ArialMT"),
axis.ticks = element_blank())
sample_cols <- c(
GSM6622231_s1 = "#0072B2",  # blue
GSM6622232_s2 = "#E69F00",  # orange
GSM6622233_s3 = "#009E73",  # green
GSM6622234_s4 = "#CC79A7"   # purple
)
# Random seed ----
RandomSeed <- 999
# load data ----
ss<- readxl::read_xlsx("data/ss.xlsx")
data_dir <- "data/samples"
sc_list <- create_seurat_list(ss, data_path = data_dir)
#create seurat object####
#set a list
create_seurat_list <- function(sample_sheet, data_path){
seurat_list <- list()
for (sample_name in sample_sheet$sample_id){
#record sample path
message (sample_name)
feat = paste0(sample_name,"_features.tsv.gz")
bc = paste0(sample_name,"_barcodes.tsv.gz")
mtx = paste0(sample_name,"_matrix.mtx.gz")
feat_file = file.path(data_path,feat)
bc_file = file.path(data_path,bc)
mtx_file = file.path(data_path,mtx)
if (!file.exists(mtx_file)) {
print("mtx does not exist")
}
if (!file.exists(feat_file)) {
print("feat_file does not exist")
}
if (!file.exists(bc_file)) {
print("bc_file does not exist")
}
#read data
data <- ReadMtx  (
mtx  = mtx_file,
features = feat_file,
cells = bc_file
)
#create seurat samples while setting the name of the asample_sheetay and project
sc_obj= CreateSeuratObject(counts = data,project = sample_name,assay = "RNA")
#add metadata
meta_row = sample_sheet[sample_sheet$sample_id==sample_name,] #match meta to p
sc_obj$group = meta_row$group
sc_obj$timepoint = meta_row$timepoint
seurat_list[[sample_name]]<-sc_obj
}
return(seurat_list)
}
# library
library(Seurat)
library(ggplot2)
library(patchwork)
#set working dir####
setwd("D:/PDAC_liver_metastasis")
#set themes ###
general_theme = theme(text = element_text(size = 12, family = "ArialMT"))
# I used the same themes
umap_theme = theme(plot.title = element_text(hjust = 0.5),
legend.position = "none",
axis.text = element_blank(),
axis.title = element_text(size = 12),
text = element_text(size = 12, family = "ArialMT"),
axis.ticks = element_blank())
sample_cols <- c(
GSM6622231_s1 = "#0072B2",  # blue
GSM6622232_s2 = "#E69F00",  # orange
GSM6622233_s3 = "#009E73",  # green
GSM6622234_s4 = "#CC79A7"   # purple
)
# Random seed ----
RandomSeed <- 999
# load data ----
ss<- readxl::read_xlsx("data/ss.xlsx")
data_dir <- "data/samples"
sc_list <- create_seurat_list(ss, data_path = data_dir)
# Quality Control ----
# add percent.mt----
for (id in names(sc_list)){
sample <- sc_list[[id]]
sample[["percent.mt"]] <- PercentageFeatureSet(sample, pattern = "^mt")
sc_list[[id]]<-sample
}
# Visualize QC metrics ----
pdf("analysis/QCVlnPlot.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p <- VlnPlot(sc_list[[id]],
features = c("nCount_RNA", "nFeature_RNA","percent.mt"))+ general_theme
print(p)
}
dev.off()
# Filter -----
min_features <- 200
max_features <- 6000
max_mt_pct <- 10
for (id in names(sc_list)){
sample <- sc_list[[id]]
sample <- subset(
sample,
subset = nFeature_RNA > min_features &
nFeature_RNA < max_features &
percent.mt < max_mt_pct
)
sc_list[[id]]<-sample
}
pdf("analysis/QCVlnPlot_PostFiler.pdf", width = 12, height = 6)
# library
library(Seurat)
library(ggplot2)
library(patchwork)
#set working dir####
setwd("D:/PDAC_liver_metastasis")
#set themes ###
general_theme = theme(text = element_text(size = 12, family = "ArialMT"))
# I used the same themes
umap_theme = theme(plot.title = element_text(hjust = 0.5),
legend.position = "none",
axis.text = element_blank(),
axis.title = element_text(size = 12),
text = element_text(size = 12, family = "ArialMT"),
axis.ticks = element_blank())
sample_cols <- c(
GSM6622231_s1 = "#0072B2",  # blue
GSM6622232_s2 = "#E69F00",  # orange
GSM6622233_s3 = "#009E73",  # green
GSM6622234_s4 = "#CC79A7"   # purple
)
# Random seed ----
RandomSeed <- 999
# load data ----
ss<- readxl::read_xlsx("data/ss.xlsx")
data_dir <- "data/samples"
sc_list <- create_seurat_list(ss, data_path = data_dir)
# Quality Control ----
# add percent.mt----
for (id in names(sc_list)){
sample <- sc_list[[id]]
sample[["percent.mt"]] <- PercentageFeatureSet(sample, pattern = "^mt")
sc_list[[id]]<-sample
}
# Visualize QC metrics ----
pdf("analysis/QCVlnPlot.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p <- VlnPlot(sc_list[[id]],
features = c("nCount_RNA", "nFeature_RNA","percent.mt"))+ general_theme
print(p)
}
dev.off()
# Filter -----
min_features <- 200
max_features <- 6000
max_mt_pct <- 10
for (id in names(sc_list)){
sample <- sc_list[[id]]
sample <- subset(
sample,
subset = nFeature_RNA > min_features &
nFeature_RNA < max_features &
percent.mt < max_mt_pct
)
sc_list[[id]]<-sample
}
pdf("analysis/QCVlnPlot_PostFiler.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p <- VlnPlot(sc_list[[id]],
features = c("nCount_RNA", "nFeature_RNA","percent.mt"))+ general_theme
print(p)
}
dev.off()
# Visualize scatter plot ----
pdf("analysis/QCScattePlot_PostFilter.pdf", width = 12, height = 6)
for (id in names(sc_list)){
p1 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "percent.mt")
p2 <- FeatureScatter(sc_list[[id]], feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
print(p1+p2)
}
dev.off()
# Merge seurat objects ----
sc_data = merge(x = sc_list[[1]], y = sc_list[-1])
saveRDS(sc_data, "data/sc_data.rds")
# LogNormalize and Scaling ----
sc_data = NormalizeData(sc_data, scale.factor = 10000)
sc_data = ScaleData(object = sc_data)
sc_data = FindVariableFeatures(object = sc_data, nfeatures = 2000)
# Retained only cells expressing macrophage markers Cd68 or Adgre1----
sc_data[["Adgre1"]] <- PercentageFeatureSet(sc_data, features = "Adgre1")
sc_data[["Cd68"]] <- PercentageFeatureSet(sc_data, features = "Cd68")
# Filter ----
sc_data <- sc_data <- subset(sc_data, subset = Adgre1 > 0 & Cd68 >0)
dim(sc_data)
print("31053   9167") # I have slightly higher cells, as I did not filer Ribo
# Dim Reduction and Clustering ----
sc_data <- RunPCA(sc_data, seed.use = RandomSeed)
ElbowPlot(sc_data)
dims_to_use <- 1:20
# cluster ----
sc_data <- FindNeighbors(object = sc_data,
dims = dims_to_use)
sc_data <- FindClusters(object = sc_data,
resolution = 0.44,
random.seed = RandomSeed)
sc_data = RunUMAP(sc_data, reduction = "pca", dims = dims_to_use, seed.use = RandomSeed)
png("analysis/umap.png", res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = T, label = T,
label.size = 6, label.color = "black") +umap_theme
dev.off()
png("analysis/umapBySample.png",res=300, width = 6*300, height = 6*300)
DimPlot(sc_data, pt.size = 0.5, order = F, label = T,
label.size = 5, label.color = "black", group.by = "group") +umap_theme
dev.off()
View(sc_data)
View(sc_data@meta.data)
save.image("D:/PDAC_liver_metastasis/session_1.RData")
